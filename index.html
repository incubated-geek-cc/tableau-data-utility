<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Generate Network Graph Data for Tableau</title>
    <link rel="icon" type="image/png" href="img/favicon32x32.png" sizes="32x32">
    <link href="css/bootstrap.min.css" type="text/css" rel="stylesheet" />
    <script src="js/jquery-2.0.0b1.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery.json-viewer.js"></script>
    <script src="js/popper.min.js"></script>
    <link href="css/jquery.json-viewer.css" type="text/css" rel="stylesheet" />
    <link href="css/custom.css" type="text/css" rel="stylesheet" />
</head>
<body>
    <div class="container">  
        <ul class="action-segments list-group list-group-flush">
            <h2 class="title">Generate Network Graph Data for Tableau</h2>
            <blockquote class="blockquote-reverse">
                Based on <a href="https://observablehq.com/@ladataviz/network-data-generator" target="blank">Network data generator for Tableau</a> 
                <footer>by <a href="https://observablehq.com/@ladataviz" target="blank">Tristan Guillevin</a></footer>

            </blockquote>
            <div class="card border-top-0 border-right-0 border-left-0">
                <div class="card-body">
                    <h4 class="card-title">Required structure of JSON file:</h4>
                    <p class="card-text">
                        – nodes: with required <code>id</code> fields<br/>
                        – links: with required <code>source</code> and <code>target</code> fields
                    </p>
                    <textarea class="jsonTree" disabled>
                    { 
                     "nodes": [
                        { "id": A },
                        { "id": B }
                      ],
                      "links": [
                        { "source": A, "target": B }
                      ]
                    }
                    </textarea>
                </div>
                <p class="card-title">
                    Here are some sample files you may download:<br />
                    ▸ <a href="data/songs.json" target="blank">songs.json</a><br />
                    ▸ <a href="data/stackoverflow.json" target="blank">stackoverflow.json</a>
                </p>
            </div>
            <p class="card-title">
                To input your own data to generate the required csv files, please proceed to input your JSON file below.
            </p>
            <li class="list-group-item list-group-item-secondary">
                <span><b>data = </b></span><input id="inputJsonFile" type="file" class="form-control-file border" name="file" />
            </li>
            <li class="list-group-item list-group-item-light">
                <span><b>data = </b></span><pre id="json-renderer"></pre>
                <textarea id="json-input" autocomplete="off" style="display:none"></textarea>
            </li>
            <li class="list-group-item list-group-item-light">
                <span><b>Download nodes.csv</b></span>
                <button id="exportNodesData" value="nodes.csv" type="button" class="btn btn-sm btn-outline-secondary">
                    <span class="spinner-border spinner-border-sm"></span>
                    Loading...
                </button>
            </li>
            <li class="list-group-item list-group-item-light">
                <span><b>Download links.csv</b></span>
                <button id="exportLinksData" value="links.csv" type="button" class="btn btn-sm btn-outline-secondary">
                    <span class="spinner-border spinner-border-sm"></span>
                    Loading...
                </button>
            </li>
            <li class="list-group-item list-group-item-secondary">
                <span><b>Implementation Example = </b></span>
                <button type="button" class="btn btn-default btn-xs" data-toggle="popover" title="Tableau Implementation" data-placement="auto right" data-content='<div class="row">
                            <div class="col-md-12" style="text-align:center">
                                <h4><b><small>Tableau Data Join</small></b></h4>
                                <img src="img/tableau_network_graph_data_join.png" height="150px" alt="tableau_network_graph_data_join" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6" style="text-align:center">
                                <h4><b><small>Network Graph Layout Preview</small></b></h4>
                                <img src="img/network_graph_layout_preview.png" height="140px" alt="network_graph_layout_preview" />
                            </div>
                            <div class="col-md-6" style="text-align:center">
                                <h4><b><small>Network Graph in Tableau</small></b></h4>
                                <img src="img/network_graph_in_tableau.png" height="140px" alt="network_graph_in_tableau" />
                            </div>
                        </div>'>
                    <img src="img/tableau_icon.png" width="25px" alt="tableau_icon" />
                </button>
            </li>
            <p class="card-title">
                To alter the layout of your network graph, feel free to configure the various parameters below. The preview will refresh itself automatically. When configurations are finally finalised, you may proceed to download the CSV files above.
            </p>
            <li class="list-group-item">
                <h4>Node</h4>
                <h5>Size (<span id="nodesizecaption">5</span>)</h5>
                <div class="form-group">
                  <input id="nodesize" type="range" class="form-control-range" name="nodesizerange" min="1" max="20" step="1" value="5" />
                </div>
                <h5>Distance (<span id="nodedistancecaption">30</span>)</h5>
                <div class="form-group">
                  <input id="nodedistance" type="range" class="form-control-range" name="nodedistancerange" min="1" max="200" step="1" value="30" />
                </div>
                <h4>Force</h4>
                <h5>Strength (<span id="nodestrengthcaption">90</span>)</h5>
                <div class="form-group">
                  <input id="nodestrength" type="range" class="form-control-range" name="nodestrength" min="0" max="250" step="1" value="90" />
                </div>
                <h5>Collide (<span id="nodecollidecaption">1</span>)</h5>
                <div class="form-group">
                    <input id="nodecollide" type="range" class="form-control-range" name="nodecollide" min="0" max="250" step="1" value="1" />
                </div>
                <mark><b>Note:</b> To adjust the node positions, select and drag <img src="img/arrow-pointer.svg" alt="node_cursor" /> the nodes directly in the graph below.</mark>
            </li>
            <li class="list-group-item">
                <svg id="networkGraph"></svg>
            </li>
        </ul>
    </div>
    <script src="js/d3.v4.min.js"></script>
    <script src="js/json2csv.js"></script>
    <script>
        $(document).ready(function() {
            $("[data-toggle='popover']").popover({
                html: true
            });

            var alphaTarget = 0.003; // 0.005
            var graphData = null;

            var nodesData = null;
            var linksData = null;

            var simulation = null;

            var containerWidth = 754;
            var height = 1150;
            var width = document.body.clientWidth;
            
            var ngraphContainer = networkGraph.parentElement;
            ngraphContainer["style"]["padding"] = "10px 0";
            ngraphContainer["style"]["position"] = "relative";
            ngraphContainer["style"]["min-height"] = "33px";
           
            ngraphContainer.parentElement["style"]["max-width"] = containerWidth + "px";
            ngraphContainer.parentElement["style"]["margin-left"] = (((width-containerWidth)/2)-34) + "px";
            ngraphContainer.parentElement["style"]["margin-right"] = ((width-containerWidth)/2) + "px";

            var svg = null;
            var link = null;
            var node = null;
            var t = null;

            function renderJson() {
                let input = null;
                try {
                    input = eval("(" + $("#json-input").val() + ")");
                } catch (error) {
                    console.log("Cannot eval JSON: " + error);
                }
                let options = {
                    collapsed: true,
                    rootCollapsable: true,
                    withQuotes: false,
                    withLinks: false
                };

                $("#json-renderer").jsonViewer(input, options);
                $("#json-renderer a:first").removeClass("collapsed");
                $("#json-renderer ul:first").css("display", "");
                document.getElementById("json-renderer").getElementsByClassName("json-placeholder")[document.getElementById("json-renderer").getElementsByClassName("json-placeholder").length-1].remove();
            }

            

            $("#nodesize, #nodecollide, #nodestrength, #nodedistance").on("change", function(e) {
                let newVal = parseFloat(e.target.value);
                $("#" + this.id + "caption").html(newVal);
                $("#networkGraph").html("");
                startLoad();
                simulation.alphaTarget(alphaTarget).restart();
                renderGraph(graphData);

                t = setInterval(() => {
                    if(simulation.alpha() < alphaTarget) {
                        stopLoad();
                        clearInterval(t);
                    }
                },1000); // end time interval
            });
            
            function startLoad() {
                $("#exportNodesData, #exportLinksData").html("<span class='spinner-border spinner-border-sm'></span> Loading...");
                $("#inputJsonFile, #exportLinksData, #exportNodesData, #nodesize, #nodecollide, #nodestrength, #nodedistance").attr("disabled",true);
            }

            function stopLoad() {
                $("#exportNodesData").html("Export nodes.csv");
                $("#exportLinksData").html("Export links.csv");
                $("#inputJsonFile, #exportLinksData, #exportNodesData, #nodesize, #nodecollide, #nodestrength, #nodedistance").attr("disabled",false);
            }

            function renderGraph(graph) {
                let strength = parseInt($("#nodestrength").val());
                let distance = parseInt($("#nodedistance").val());
                let size = parseInt($("#nodesize").val());
                let collide = parseInt($("#nodecollide").val());

                svg = d3.select("svg").attr("viewBox", [-width/2,-height /2,width,height]);

                link = svg.append("g")
                            .attr("class", "links")
                            .attr("stroke", "#dddddd")
                            .attr("stroke-opacity", 1)
                        .selectAll("line")
                        .data(graph.links)
                        .enter().append("line")
                            .attr("stroke-width", d=> Math.sqrt(d.value));

                node = svg.append("g")
                                .attr("class", "nodes")
                                .attr("stroke", "#000000")
                                .attr("stroke-width", 0.5)
                            .selectAll("g")
                            .data(graph.nodes)
                            .enter().append("g")
                            .append("circle")
                                .attr("r", d => size)
                                .on('mouseover', function() {
                                    d3.select(this)
                                        .transition()
                                        .duration(50)
                                        .attr("fill", "#f00000")
                                })
                                .on('mouseout', function(){
                                    d3.select(this)
                                        .transition()
                                        .duration(50)
                                        .attr("fill", "#a6a6a6")
                                })
                                .call(d3.drag()
                                    .on("start", dragstarted)
                                    .on("drag", dragged)
                                    .on("end", dragended)
                            );

                $("#json-input").val(JSON.stringify(graph));
                renderJson();
                simulation = d3.forceSimulation()
                                    .nodes(graph.nodes)
                                    .force("link", d3.forceLink(graph.links).id(d=> d.id))
                                    .force("charge", d3.forceManyBody().strength(-strength))
                                    .force("collide", d3.forceCollide(d=> size+collide ))
                                    .force("x", d3.forceX())
                                    .force("y", d3.forceY());
                      
                simulation.force("link")
                    .links(graph.links)
                    .distance(distance);

                simulation
                    .on("tick", ()=>{
                        link
                            .attr("x1", d=> d.source.x)
                            .attr("y1", d=> d.source.y)
                            .attr("x2", d=> d.target.x)
                            .attr("y2", d=> d.target.y);
                        node
                            .attr("cx", d=>d.x)
                            .attr("cy", d=>d.y);
                    });

                nodesData = graph.nodes;
                linksData = graph.links;
            }
            
            function dragstarted(d) {
                if (!d3.event.active) {
                    startLoad();
                    simulation.alphaTarget(alphaTarget).restart();
                }

                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(d) {
                d.fx = d3.event.x;
                d.fy = d3.event.y;
            }

            function dragended(d) {
                if (!d3.event.active) {
                    simulation.alphaTarget(0);
                }
                stopLoad();

                d.fx = null;
                d.fy = null;
            }

            d3.json("data/data.json", function(error, graph) {
                if (error) {
                    console.log(error);
                }
                graphData = graph;
                $("#networkGraph").html("");
                startLoad();
                renderGraph(graph);

                $("#exportLinksData").click(function(e) {
                    let saveas = e.target.value;

                    let links_data = [];
                    for(let linkIndex in linksData) {
                        let linkObj = linksData[linkIndex];
                     
                        let obj = {
                            "key": linkObj["index"],
                            "type": "source"
                        };
                        let linkKey = "";
                        for(linkKey in linkObj["source"]) {
                            linkObj["source"][linkKey] = linkObj["source"][linkKey];
                            obj[linkKey] = linkObj["source"][linkKey];
                        }
                        links_data.push(obj);
                        
                        obj = {
                            "key": linkObj["index"],
                            "type": "target"
                        };
                        linkKey = "";
                        for(linkKey in linkObj["target"]) {
                            linkObj["target"][linkKey] = linkObj["target"][linkKey];
                            obj[linkKey] = linkObj["target"][linkKey];
                        }
                        links_data.push(obj);
                    }

                    // derive "link_id" from links_data
                    var link_id = "";
                    for(let lk in links_data) {
                        if(lk % 2 == 1) { // target
                            link_id+=links_data[lk]["id"];
                            links_data[lk-1]["link_id"] = link_id;
                            links_data[lk]["link_id"] = link_id;

                            link_id="";
                        } else { // source
                            link_id+=links_data[lk]["id"] + "_";
                        }
                    }

                    converter.json2csvAsync(links_data, {
                        prependHeader: true,
                        sortHeaderv: true,
                        trimFieldValues: true,
                        trimHeaderFields: true,
                        emptyFieldValue: "",
                        delimiter: {
                            field: ",",
                            wrap: "\"",
                            eol: "\n"
                        }
                    })
                    .then((csvDataOutput) => {
                        let txtwrt = csvDataOutput;
                        if (!window.Blob) {
                            alert("Your browser does not support HTML5 'Blob' function required to save a file.");
                        } else {
                            let textblob = new Blob([txtwrt], {
                                type: "text/plain"
                            });
                            let dwnlnk = document.createElement("a");
                            dwnlnk.download = saveas;
                            dwnlnk.innerHTML = "Download File";
                            if (window.webkitURL != null) {
                                dwnlnk.href = window.webkitURL.createObjectURL(textblob);
                            } else {
                                dwnlnk.href = window.URL.createObjectURL(textblob);
                                dwnlnk.onclick = destce;
                                dwnlnk.style.display = "none";
                                document.body.appendChild(dwnlnk);
                            }
                            dwnlnk.click();
                        }
                    })
                    .catch((err) => console.log('ERROR: ' + err.message));
                });
                
                $("#exportNodesData").click(function(e) {
                    let saveas = e.target.value;

                    converter.json2csvAsync(graphData["nodes"], {
                        prependHeader: true,
                        sortHeaderv: true,
                        trimFieldValues: true,
                        trimHeaderFields: true,
                        emptyFieldValue: "",
                        delimiter: {
                            field: ",",
                            wrap: "\"",
                            eol: "\n"
                        }
                    })
                    .then((csvDataOutput) => {
                        let txtwrt = csvDataOutput;
                        if (!window.Blob) {
                            alert("Your browser does not support HTML5 'Blob' function required to save a file.");
                        } else {
                            let textblob = new Blob([txtwrt], {
                                type: "text/plain"
                            });
                            
                            let dwnlnk = document.createElement("a");
                            dwnlnk.download = saveas;
                            dwnlnk.innerHTML = "Download File";
                            if (window.webkitURL != null) {
                                dwnlnk.href = window.webkitURL.createObjectURL(textblob);
                            } else {
                                dwnlnk.href = window.URL.createObjectURL(textblob);
                                dwnlnk.onclick = destce;
                                dwnlnk.style.display = "none";
                                document.body.appendChild(dwnlnk);
                            }
                            dwnlnk.click();
                        }
                    })
                    .catch((err) => console.log("ERROR: " + err.message));
                }); 

                if(simulation.alpha() < alphaTarget) {
                    simulation.stop();
                }
            }); // end d3.json

            t = setInterval(() => {
                if(simulation.alpha() < alphaTarget) {
                    stopLoad();
                    clearInterval(t);
                }
            },1000); // end time interval

            $("#inputJsonFile").click(function(e) {
                e.target.value = "";
            });

            $("#inputJsonFile").change(function(e) {
                let fileName = e.target.value;
                fileName = fileName.split("\\")[2];
                let n = fileName.lastIndexOf(".");
                fileName = fileName.substring(0,n) + ".csv";

                $("#exportNodesData").val("nodes_" + fileName);
                $("#exportLinksData").val("links_" + fileName);

                if (!window.FileReader) {
                    alert("Your browser does not support HTML5 'FileReader' function required to open a file.");
                } else {
                    let fileis = this.files[0];
                    let fileredr = new FileReader();
                    fileredr.onload = function (fle) {
                        let filecont = fle.target.result;
                        $("#json-input").val(filecont);

                        renderJson();
                        let graph = JSON.parse(filecont);
                        graphData = graph;

                        simulation.alphaTarget(alphaTarget).restart();
                        $("#networkGraph").html("");
                        startLoad();
                        renderGraph(graph);

                        t = setInterval(() => {
                            if(simulation.alpha() < alphaTarget) {
                                stopLoad();
                                clearInterval(t);
                            }
                        },1000); // end time interval
                    }
                    fileredr.readAsText(fileis);
                }
            }); // new file input
        }); // document.ready
    </script>
</body>